eit_txtout

★★★
★★★はじめに
★★★
TSファイルに含まれる番組情報(EIT)を解析し、含まれる情報をテキストファイルで
出力するプログラムです。

TvRockとか使っててtsファイルの内容によってスクリプト処理したいけど、自分が
欲しい情報を吐いてくれるのが無いっぽかったので作りました。主にスクリプト処
理しやすいように整形してあるので、人間様が見てもイマイチ見にくかったりしま
す(^_^;

Visual Studio 2010のランタイムDLLは要らないように作ったつもりですが、確認し
てないので、起動時にエラーが出たら入れて下さい

★★★
★★★実行方法
★★★

eit_txtout.exe [option] (input) (output)

(input)     入力TSファイル。

(output)    出力するテキストファイル名

[option]は以下の通り。大文字・小文字を区別するんで注意

-o (value)  数値を指定した場合、188*1000*#(value) byte分オフセットした位置
            から読み込みます。ファイルサイズより大きい値を指定した場合、読
            み込まれないんで注意。
            末尾に"%"を入れると読み込むサイズ比率を指定できます。
            指定しない場合先頭から読み込みます。

-r (value)  数値を指定した場合、188*1000*#(value) byte分読み込みます。ファ
            イルサイズより大きい値を指定した場合、自動的に切り詰められま
            す。
            末尾に"%"を入れると読み込むサイズ比率を指定できます。
            末尾に"s"を入れるとtsファイル内の録画秒数分読み込んだところで読
            込処理を終了します。
            指定しない場合全部読み込みます。-aオプションや-sオプションを付
            けない場合、10sも読めば充分です。

-d (name)   デバッグ用ダンプ出力(#はファイル名)
            読み込んだPAT,PMT,SDT,EIT,TOT/TDTの情報を指定したテキストファイ
            ルに出力します
            内部でソートしてるので、出力される順序は入力ファイルの順序とは
            異なる部分があります
            書式はコロコロ変わると思うんで、これの出力ファイル内容をスクリ
            プト処理するのはやめときましょう。

-l (name)   デバッグログ出力(#はファイル名)。
            想定外の動きをした際にファイルにそのメッセージを出力します。
            なんか動きがおかしい時に指定して、その内容を報告してくれると修
            正できるかも知れません
            
-V          詳細出力モード。
            デバッグログ出力(-lオプション)を指定しないとき標準ログ出力にデ
            バッグログを出力します            

-n          進捗表示(%)を標準出力に出力しない
            なんか表示すると処理が遅くなったりするので、付けてあります。

-s          TSファイル内のEITのうちスケジュール情報(テーブルID 0x50～0x6F)
            も読み込みます。
            指定すると若干遅くなると思います。
            
-B (sec)    トランスポートストリーム(TSファイル)の開始日時を指定された秒数
            分オフセットします
            全部読み込む際、TvRockとかで録画開始を○秒前からにしてると、前
            番組のイベントが出力されるのを防ぎます。      

-E (sec)    トランスポートストリーム(TSファイル)の終了日時を指定された秒数
            分オフセットします
            全部読み込む際、TvRockとかで録画終了を○秒後までにしてると、後
            番組のイベントが出力されるのを防ぎます。
            なお、指定されたTSファイルの録画秒数が開始オフセット秒数＋終了
            オフセット秒数に満たない場合、開始日時と終了日時の中央値で処理
            されます。

-T          指定するとテキストファイル出力のTOT～の開始日時、終了日時が開始
            /終了オフセット秒数の影響を受けます

-e (type)   テキストファイル出力のEVT～の出力形式を指定します
            1以上   映像フォーマット、コンポーネント値を出力します
            2以上   イベント内容を出力します

-x          テキストファイル出力にXEVT(拡張イベント記述子)を出力します

-p          テキストファイル出力にPATとPMTを出力します
            指定すると若干遅くなると思います。

-a          読み込んだサービス、イベントを全て出力します
            番組表みたいなものを作りたい場合、-sオプションも指定しないと、
            現在と次の番組しか出力されません。
            指定しない場合、入力ファイル内に映像/音声/データ放送が含まれる
            サービス、イベント(番組)のみを出力します。



(例)
オプションとオプション引数はスペースで区切っても区切らなくてもOK
eit_txtout.exe -o10% -r10s hoge.ts hoge.txt

eit_txtout.exe -o 10% -r 10s hoge.ts hoge.txt

引数を取らないオプションの場合、連続して指定できます
eit_txtout.exe -xo10% -r60s hoge.ts hoge.txt


【返り値】
0	正常終了
1	パラメータエラー(マイナスの値指定とか)
2	入力ファイルエラー(入力ファイルを指定してないとか)
3	出力ファイルエラー(出力ファイルを指定してないとか)
4	TSファイル内にTOT情報がない
5	TSファイル内にPAT情報がない
6	TSファイル内にEIT情報がない

★★★
★★★テキストファイル形式
★★★

指定されたTSファイル内に映像/音声/データ放送が含まれるサービス、イベント(番
組)のみを出力します。(-aオプションがない場合)
厳密に言うとPATに定義されたサービスのうち、TOT/TDTの最初と最後の時刻よりデ
ータがあると思われるイベントのみを出力します。
PMTのelementary_PIDがあるかどうかまではチェックしてません。

-aオプションを指定した場合、指定しない場合どちらでも重複した情報は出力され
ません

数値は特に指定がない場合、全て10進整数です。

なお<TAB>は水平タブを意味します。全ての書式は1行で出力されます。(途中の改行
は見栄え的にそうしてあるだけです)

■■[A]■■
TOT<TAB>開始日時<TAB>終了日時

(0)開始日時
読み込んだトランスポートストリーム(TSファイル)内で最初に規定されるTOT(また
 はTDT)の日時を"yyyy/mm/dd HH:MM:SS"という形式で出力します。
-Bオプションで指定した開始オフセット秒数の影響を受けるかどうかは-Tオプショ
 ンの有無によって変わります

(1)終了日時
読み込んだトランスポートストリーム(TSファイル)内で最後に規定されるTOT(また
はTDT)の日時を"yyyy/mm/dd HH:MM:SS"という形式で出力します。
-Eオプションで指定した終了オフセット秒数の影響を受けるかどうかは-Tオプショ
ンの有無によって変わります

※ 2011/11/30現在TOT/TDTは5秒に1回のペースで配信されるみたいです(地上波/BS/
   CSで確認)。
   なので、開始日時と終了日時は実際の録画時間から5秒程度の誤差が発生しま
   す。
   但し、ARIB STD-B10(v4.9)によるとTOTまたはTDTは30秒に1回以上配信しない
   といけないとなってるので、配信の間隔が今以上に大きくなる(誤差が大きくな
   る)可能性もあります。

■■[B]■■
SVC<TAB>ネットワークID<TAB>トランスポートID<TAB>サービス番号<TAB>放送種別
        <TAB>サービス名<TAB>サービスプロバイダ名<TAB>サービス形式種別

(0)ネットワークID
SDT/EITで指定されるネットワーク識別ID。ARIB STD-B10(v4.9)の第2部 表N-1参照

(1)トランスポートID
SDT/EITで指定されるネットワーク内で他と識別するID。

(2)放送種別
ネットワークIDを"BS"、"CS"、"地デ"、"その他"の文字列に変換して出力します。

(3)サービス番号
トランスポート内でサービスを特定する数値

(4)サービス名
いわゆるチャンネル名("ＮＨＫＢＳ１"など)

(5)サービスプロバイダ名
サービス事業者名("ＮＨＫ"など)

(6)サービス形式種別
サービスの種類を10進数字で出力。ARIB STD-B10(v4.9)の第2部 表6-25参照
192ならデータサービスなんで、データ放送のサービスを無視するとかいう処
理が可能

■■[C]■■
EVT<TAB>サービス番号<TAB>イベントID<TAB>開始日時<TAB>終了日時
        <TAB>イベント名<TAB>ジャンル値<TAB>ジャンル大分類
		<TAB>ジャンル中分類        
        [<TAB>映像フォーマット<TAB>コンポーネント値]  (-eで1以上指定時)
        [<TAB>イベント内容]                           (-eで2以上指定時)
※ 同じサービスに属するイベントは開始日時でソートされて出力されます

(0)サービス番号
トランスポート内でサービスを特定する数値

(1)イベントID
サービス内で一意的に割り当てられるイベントを特定する数値

(2)開始日時
イベントの開始日時を"yyyy/mm/dd HH:MM:SS"という形式で出力します。

(3)終了日時
イベントの終了日時を"yyyy/mm/dd HH:MM:SS"という形式で出力します。

(4)イベント名
いわゆる番組名

(5)ジャンル値
-1～255の範囲の値を取る。0～255の値の時上位4ビットがジャンル大分類
(content_nibble_level_1)、下位4ビットがジャンル中分類(content_nibble_
level_2)となる。ARIB STD-B10(v4.9)の第2部 付録N参照。
ただし-1の時ジャンル指定なし(コンテント記述子がない)を意味します

(6)ジャンル大分類
ジャンル値をARIB STD-B10(v4.9)の第2部 付録Nの表を元にしたジャンル大分
類文字列

(7)ジャンル中分類
ジャンル値をARIB STD-B10(v4.9)の第2部 付録Nの表を元にしたジャンル中分
類文字列

(8)映像フォーマット
映像フォーマットを文字列(180p/240p/480i/480p/720p/1080i/1080p/2160pの
どれか。コンポーネント内容が音声などの場合"非映像"、コンポーネント記
述子がない場合は"非指定")で出力します。

(9)コンポーネント値
-1～4095の値を取る。0～4095の時上位4ビットがコンポーネント記述子のコ
ンポーネント内容(stream_content)、下位8ビットがコンポーネント種別(com
ponent_type)となる。ARIB STD-B10(v4.9)の第2部 表6-5参照。
映像フォーマット以外の情報(アスペクト比とか)が欲しい場合、この値を処
理すれば良い。
-1の時コンポーネント記述子がないことを意味します。

(10)イベント内容
いわゆる番組説明

■■[D]■■(-x指定時)
XEVT<TAB>サービス番号<TAB>イベントID<TAB>連番<TAB>項目説明<TAB>項目内容

(0)サービス番号
トランスポート内でサービスを特定する数値

(1)イベントID
サービス内で一意的に割り当てられるイベントを特定する数値

(2)連番
同じイベント内で0から始まる連番

(3)項目説明
項目名。【出演者】とか

(4)項目内容                
項目名の詳細内容


■■[E]■■(-p指定時)
PAT<TAB>PATグループID<TAB>トランスポートID<TAB>連番<TAB>サービス番号<TAB>PMTのPID

(0)PATグループID           
0から始まる連番。値が同じ項目は同じPATグループに属することを意味する

(1)トランスポートID        
SDT/EITで指定されるネットワーク内で他と識別するID(10進数字)。

(2)連番                    
同じPATグループ内での0から始まる連番。

(3)サービス番号            
トランスポート内でサービスを特定する10進数字

(4)PMTのPID                
10進数字。PMTと情報をリンクできる

■■[F]■■(-p指定時)
PMT1<TAB>PMTグループID<TAB>PMTのPID<TAB>サービス番号<TAB>連番<TAB>ストリーム種別<TAB>エレメンタリーPID

(0)PMTグループID           
0から始まる連番。値が同じ項目は同じPMTグループに属することを意味する

(1)PMTのPID                
10進数字。PATと情報をリンクできる

(2)サービス番号            
トランスポート内でサービスを特定する10進数字

(3)連番                    
同じPMTグループ(PMTのPIDが同じ項目)内での0から始まる連番。

(4)ストリーム種別          
ARIB STD-B10(v4.9)の第2部 表E-4で定義される10進数字

(5)エレメンタリーPID       
画像や音声などのPID

■■[G]■■(-p指定時)
PMT2<TAB>PMTグループID<TAB>PMTのPID<TAB>サービス番号<TAB>ファイル位置<TAB>PCR_PID

(0)PMTグループID
0から始まる連番。値が同じ項目は同じPMTグループに属することを意味する

(1)PMTのPID                
10進数字。PATと情報をリンクできる

(2)サービス番号            
トランスポート内でサービスを特定する10進数字(AT-Xなら333とかいう数字)

(3)ファイル位置            
そのPMTが入力ファイル内で始めて現れた位置を10進数字で出力。
単位は先頭値が1のパケット単位なので、バイト単位にする場合は1引いてか
ら188を掛ければいいです
サービスによっては番組の切り替わり時にPMTの情報が変更される場合がある
ので、それを検出できます

(4)PCR_PID                 
意味はよく知らない。何かに使えるかも？


★★★
★★★制限事項
★★★
TSパケットサイズは188バイトのみ対応してます。TSパケットサイズが192バイトや2
04バイトとなってるファイルは正常に読み込めません。

★★★
★★★ライセンス
★★★
epgdumpのaribstr.cを一部改変して使用してます。
ということで、そのライセンスに従います
以下引用。
>epgdumpに関しては、BonTest Ver.1.40からそのままソースを持ってきている部分も
>あるため、そのライセンスに従いします。
>BonTestのReadme.txtより
>>
>>３．ライセンスについて
>>　　・本パッケージに含まれる全てのソースコード、バイナリについて著作権は一切主張しません。
>>　　・オリジナルのまま又は改変し、各自のソフトウェアに自由に添付、組み込むことができます。
>>　　・但しGPLに従うことを要求しますのでこれらを行う場合はソースコードの開示が必須となります。
>>　　・このとき本ソフトウェアの著作権表示を行うかどうかは任意です。
>>　　・本ソフトウェアはFAAD2のライブラリ版バイナリを使用しています。
>>
>>　　　"Code from FAAD2 is copyright (c) Nero AG, www.nero.com"
>>
>>　　・ビルドに必要な環境
>>　　　- Microsoft Visual Studio 2005 以上　※MFCが必要
>>　　　- Microsoft Windows SDK v6.0 以上　　※DirectShow基底クラスのコンパイル済みライブラリが必要
>>　　　- Microsoft DirectX 9.0 SDK 以上


★★★
★★★サンプルスクリプトについて
★★★
eit_txtoutの使用例の１つとして、

引数で渡されたTSファイルを解析し、ジャンル・またはタイトルを含むサブフォルダ
にコピーまたは移動するスクリプトを付属してあります。

TVRockとかで[録画終了後等にプログラムを実行]に
-----
アニメ:copy "%1" f:\store_dir\@アニメ
映画:copy "%1" f:\store_dir\@映画
ルパン:copy "%1" f:\store_dir\@アニメ\ルパン
-----
とかって書いて、予約毎に終了後コマンド選択するのなんてやってられるか！とい
う向きにはお奨めです。

実行は
>cscript SamleFCopy.js <TSファイル> <サービス№>
て感じで。Echo()を使ってるんでwscriptだと鬱陶しいと思う。

なお1サービスしか入ってないTSファイルならサービス№は省略しても大丈夫です。
複数サービスが入ってるTSファイルでサービス№を省略すると出力テキストファイ
ル内で最初のイベントのジャンルを取得します。

実行ファイルの場所や保管フォルダの場所は自身の環境に合わせてSampleFCopy.js
を変更して下さい。その他詳しい動作仕様は同スクリプトファイルに書いてあるん
で参照して下さい

なお一通りのテストはしてありますが、TSファイルはバックアップを取って動作実
験を行ってから使用して下さい。


★★★
★★★参考文献、URLとか
★★★
下記のページ、文書を参考にしました。

「TSファイルから番組内容を取得する」
http://txqz.net/blog/2011/05/23/2056

「標準規格（放送分野）一覧表(ARIB)」
http://www.arib.or.jp/tyosakenkyu/kikaku_hoso/hoso_kikaku_number.html
の中の
2-STD-B10v4_9.pdf

「デジタル映像の「アーカイブ;デリバリー」に関する技術情報サイト｜mpeg.co.jp ; VIDEO-ITを取り巻く市場と技術」
の中の
「第3回」http://www.mpeg.co.jp/libraries/video_it/video_03.html
「第4回」http://www.mpeg.co.jp/libraries/video_it/video_04.html

また、
・TsRenameのソースコード
・epgdumpのソースコード
・tsselectのソースコード
を実装にあたっては参考にさせていただきました。ありがとうございました。

wingetopt.h/wingetopt.cppは
http://note.sonots.com/Comp/CompLang/cpp/getopt.html
の内容をほぼそのままいただきました<(_ _)>

★★★
★★★その他
★★★
Visual Studio 2010で開発しました。

Windows XP(SP3)で動作確認しました
TSファイルはPT1+TVTest+TVRock環境でのファイルで確認してます。

もし「Linuxとかで使いたい！」という向きは処理系依存では極力書かないようにし
てるけど
・tchar.h系の関数(_tcs～)を#defineとかで適当に置き換える
・crtdbg.h系のマクロ(_ASSERTとか)を#defineとかで適当に置き換える
・Unicode出力したい場合はMultiByteToWideCharをiconvとかに変える
・fseek()が64ビット対応でないので、_fseeki64()を使ってる部分を修正する
とかは直さないといけないと思う
STLや標準ライブラリの仕様を見て作ってるわけでは無いんで、他にMicrosoftの独
自拡張に引っかかってたり、お約束違反があったらごめんなさい<(_ _)>

C++0x(正式にはC++11)拡張は使ってないつもりです。

お約束ですが、本ソフトを使用していかなる損害を被っても責任は持てません。
各自の責任においてご使用下さい。

★★★
★★★変更履歴
★★★
